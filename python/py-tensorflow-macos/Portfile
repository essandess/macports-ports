# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           python 1.0

name                py-tensorflow-macos
version             2.13.0
revision            0

categories-append   lang
license             Apache-2
maintainers         nomaintainer
supported_archs     arm64 x86_64

description         Mac-optimized TensorFlow to be used with py-tensorflow-metal.

long_description    Hardware-accelerated TensorFlow and TensorFlow \
                    Addons for macOS 12.0+. Native hardware \
                    acceleration is supported on M1 Macs and \
                    Intel-based Macs through Appleâ€™s ML Compute \
                    framework.

homepage            https://developer.apple.com/metal/tensorflow-plugin/

extract.suffix      .whl
extract.only

# set build_arch by hand on arm64/x86_64 systems to get x86_64/arm64 checksums
# sudo port -d checksum py310-tensorflow-macos os.arch=arm build_arch=arm64
# run `port clean --all py*-tensorflow-macos` afterwards

python.versions 38 39 310 311
python.pep517       yes
python.pep517_backend

set minimum_supported_major_version 21
if {${os.arch} ni [list arm i386]
    || ${os.platform} eq {darwin}
        && ${os.major} < ${minimum_supported_major_version}} {
    known_fail      yes
    pre-fetch {
        ui_error "TensorFlow with ML Compute acceleration is only available \
            on macOS [expr ${minimum_supported_major_version} - 9] and later \
            with [join ${supported_archs} " or "] architectures."
        error {unsupported platform}
    }
}

if {${name} ne ${subport}} {
    conflicts       py${python.version}-tensorflow \
                    py${python.version}-tensorflow1 \
                    py${python.version}-tensorflow-addons

    # https://pypi.org/project/tensorflow-macos/#files
    if {${build_arch} eq {arm64}} {
        if {${python.version} eq 311} {
            master_sites \
                    https://files.pythonhosted.org/packages/f1/cc/6c262ae6f3a23b118b1104fa5f6126067744ffa9226faade202b0a20bdd3/
            checksums \
                    rmd160  aff695db402a7cfc0b41a82e0e5262be0a5e9c2c \
                    sha256  5dca8291125c0151bf426a2789689e02c623ce4540432cf66a073d361d3d6870 \
                    size    189326775
        } elseif {${python.version} eq 310} {
            master_sites \
                    https://files.pythonhosted.org/packages/77/29/b3a46ade07623f29d64cb43433aa1c6ba2bfe7419daee76f0cc9a6f7213a/
            checksums \
                    rmd160  d8195767f49210efc3432eebf392dcfba88f6834 \
                    sha256  331cc23682374ca5f3f92e069bd7fbb6e4d48a50278a9cd05e5b33f16d9a31e7 \
                    size    189282692
        } elseif {${python.version} eq 39} {
            master_sites \
                    https://files.pythonhosted.org/packages/c4/4d/8dcb9ddf53ad0070cccb50cbdaad29d1a226a253966d9a6b1de34bd61ec4/
            checksums \
                    rmd160  19a73751b8c8f44db8084c514d3b9589455202ca \
                    sha256  d9571357a39cc8cdecfd22e67dfdcebf840be67a88a8c7464bd3b9b3e0aad446 \
                    size    189281966
        } elseif {${python.version} eq 38} {
            master_sites \
                    https://files.pythonhosted.org/packages/62/9d/82475d2553d218f8df5d1efd310e8e65e3bfb6cec429a49a3a9489f2fb62/
            checksums \
                    rmd160  e2110951b1c1586ec165be9b78f74f55909462f4 \
                    sha256  b0cea604f50a032dc426d7a6a91dc53a9df001cfa94fc814972e9d4cf062d31b \
                    size    189257389
        }
    } elseif {${build_arch} eq {x86_64}} {
        # last x86_64 supported version
        version     2.12.0
        revision    0

        if {${python.version} eq 311} {
            master_sites \
                    https://files.pythonhosted.org/packages/67/4a/a39d10a1f2f3b13bc845a13d7f7f771fa93ee67fc36c697ade5c203727b3/
            checksums \
                    rmd160  8a4bbbfc66fea9eb5c6c322a93bcfa736def6ab3 \
                    sha256  6a54539bd076746f69ae8bef7282f981674fe4dbf59c3a84c4af86ae6bae9d5c \
                    size    228485947
        } elseif {${python.version} eq 310} {
            master_sites \
                    https://files.pythonhosted.org/packages/b7/22/1520a91aba27dcc60951c98e18e3992ddc893c031c6e9529a0edaf3d6935/
            checksums \
                    rmd160  f3d921cd61378d54e885f74298f61c0fcef41211 \
                    sha256  172277c33cb1ae0da19f98c5bcd4946149cfa73c8ea05c6ba18365d58dd3c6f2 \
                    size    228442909
        } elseif {${python.version} eq 39} {
            master_sites \
                    https://files.pythonhosted.org/packages/67/da/3b3f5ab3644aba3c13534ca2338c6c6cd654b3406b9c450d1b13c5c09b27/
            checksums \
                    rmd160  f654ca2e8c3a238d1fefe3cd6a113d948bb4e887 \
                    sha256  85d9451a691324490e1d644b1051972e14edc249004eef5831b3510df9e36515 \
                    size    228443316
        } elseif {${python.version} eq 38} {
            master_sites \
                    https://files.pythonhosted.org/packages/ff/dc/597f716f99b22c1c3044c33b777d27b4b11bf0e87885944140d670edede2/
            checksums \
                    rmd160  40b74057ae97773a5c8527a4b2ad5d04fa0e4208 \
                    sha256  5499312c21ed3ed47cc6b4cf861896e9564c2c32d8d3c2ef1437c5ca31adfc73 \
                    size    228415423
        }
    }
    distname tensorflow_macos-${version}-cp${python.version}-cp${python.version}-macosx_12_0_${build_arch}

    depends_run-append \
                    port:py${python.version}-absl \
                    port:py${python.version}-astunparse \
                    port:py${python.version}-flatbuffers \
                    port:py${python.version}-gast \
                    port:py${python.version}-grpcio \
                    port:py${python.version}-h5py \
                    port:py${python.version}-keras \
                    port:py${python.version}-keras_preprocessing \
                    port:py${python.version}-numpy \
                    port:py${python.version}-opt_einsum \
                    port:py${python.version}-protobuf3 \
                    port:py${python.version}-tensorflow_estimator \
                    port:py${python.version}-scipy \
                    port:py${python.version}-tensorboard \
                    port:py${python.version}-termcolor \
                    port:py${python.version}-typing_extensions \
                    port:py${python.version}-wrapt \
                    port:py${python.version}-typeguard

    build           {}

    destroot.target ${distpath}/${distfiles}

    post-destroot {
        # avoid conflict with py${python.version}-tensorboard
        delete      ${destroot}${python.prefix}/bin/tensorboard \
                    ${destroot}${prefix}/bin/tensorboard-${python.branch}
    }
}
