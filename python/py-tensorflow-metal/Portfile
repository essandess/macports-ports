# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           python 1.0

name                py-tensorflow-metal
version             1.0.1
revision            0

categories-append   lang
license             MIT
maintainers         nomaintainer
supported_archs     arm64 x86_64

description         TensorFlow acceleration for Mac GPUs.

long_description    Hardware-accelerated TensorFlow and TensorFlow \
                    Addons for macOS 12.0+. Native hardware \
                    acceleration is supported on M1 Macs and \
                    Intel-based Macs through Appleâ€™s ML Compute \
                    framework.

homepage            https://developer.apple.com/metal/tensorflow-plugin/

extract.suffix      .whl
extract.only

# set build_arch by hand on arm64/x86_64 systems to get x86_64/arm64 checksums
# sudo port -d checksum py310-tensorflow-metal os.arch=arm build_arch=arm64
# run `port clean --all py*-tensorflow-metal` afterwards

python.versions 38 39 310 311
python.pep517       yes
python.pep517_backend

set minimum_supported_major_version 21
if {${os.arch} ni [list arm i386]
    || ${os.platform} eq {darwin}
        && ${os.major} < ${minimum_supported_major_version}} {
    known_fail      yes
    pre-fetch {
        ui_error "TensorFlow with ML Compute acceleration is only available \
            on macOS [expr ${minimum_supported_major_version} - 9] and later \
            with [join ${supported_archs} " or "] architectures."
        error {unsupported platform}
    }
}

if {${name} ne ${subport}} {
    # https://pypi.org/project/tensorflow-metal/#files
    if {${build_arch} eq {arm64}} {
        if {${python.version} eq 311} {
            master_sites \
                    https://files.pythonhosted.org/packages/e8/a2/16b46cd175d5e878645ef6d53ce1cd81cb4aa001f2b69ace6c9f72e30dab/
            checksums \
                    rmd160  39eadefd093918981621c157cd2560eccfe31153 \
                    sha256  bfc7b36a4bed76b00455636cb7c802e98450d6cdc915e5c71405ce492a3e6b3a \
                    size    1392863
        } elseif {${python.version} eq 310} {
            master_sites \
                    https://files.pythonhosted.org/packages/f3/3d/0796dda099a84e166aacb493f8a161c8816175e514e79012b940364787d4/
            checksums \
                    rmd160  14c8818cf1ba12495cb37b97577da393f1854ce7 \
                    sha256  6cd2266b5201b249de2916ab643e72be34440d26716fa62daaeea6442814a9b7 \
                    size    1392862
        } elseif {${python.version} eq 39} {
            master_sites \
                    https://files.pythonhosted.org/packages/5d/e3/afd480ccd85304e740918ce37e4120233dd507f64cbb34cae945ddfc9c74/
            checksums \
                    rmd160  bbb7d1ba143842b4f17b2011d69c2a4b0a17bb44 \
                    sha256  236b3585824088a56cda41c79b54bf1ae717bf32c0d7907d5119aef06f81df02 \
                    size    1392862
        } elseif {${python.version} eq 38} {
            master_sites \
                    https://files.pythonhosted.org/packages/7e/4a/17ce1eb4ef0e7ebca58a409f4536fbaffd27f3e88d5a2e4d13afac2a622c/
            checksums \
                    rmd160  57eac26349b564711e424464ff6b8c3e008522d4 \
                    sha256  0c8ae71bec85625b3655ca65810ed26d5f17bd23eb4c2c94e4e49c7e7fa2e5f7 \
                    size    1393549
        }
    } elseif {${build_arch} eq {x86_64}} {
        # last x86_64 supported version
        version     1.0.0
        revision    0

        if {${python.version} eq 311} {
            master_sites \
                    https://files.pythonhosted.org/packages/20/7f/042d5becc70e9b17fb0f594581a9a288e3c4cb547aae96c8e2e1b1d75f77/
            checksums \
                    rmd160  ff8cb3f50609575dfddc2a4c14cc8631480b22ae \
                    sha256  dd35b1786f3785404009ff78335270676cbc7f797b50e22eb9ef29e8502c608a \
                    size    1503337
        } elseif {${python.version} eq 310} {
            master_sites \
                    https://files.pythonhosted.org/packages/75/be/87106ff0fe629978157e02cf2dfff65f338fd9e08dd371b22cde9f1c9f52/
            checksums \
                    rmd160  1678647d1f147b3f7cdad02598c8e78474ac3f52 \
                    sha256  b26030fcbf31a3acb06f016f53778f29f525b55e317914440d7a0eff87c54fc8 \
                    size    1503337
        } elseif {${python.version} eq 39} {
            master_sites \
                    https://files.pythonhosted.org/packages/19/e1/5338b92dbdb63d67779a4493e1bd6df8e5f1fb2dc6100dd837015c97bd78/
            checksums \
                    rmd160  84dc9cecb2eebc7b62be1731cdae2367ba310684 \
                    sha256  a00a60f69c2543282f153e4af5561062391d56c29ef218b78293c0d217748efa \
                    size    1503335
        } elseif {${python.version} eq 38} {
            master_sites \
                    https://files.pythonhosted.org/packages/34/90/3498d026f46a340cf0ea0be4ff794f9d64023c66432be85bb8516439dc52/
            checksums \
                    rmd160  4c53444b69b19a815976573a7708f3fd0d73404a \
                    sha256  35893bf6a2b588176191121ad56c99220f1e76049afea3ae025614d36dfca0f4 \
                    size    1504022
        }
    }
    distname tensorflow_metal-${version}-cp${python.version}-cp${python.version}-macosx_12_0_${build_arch}

    depends_run-append \
                    port:py${python.version}-tensorflow-macos

    build           {}

    destroot.target ${distpath}/${distfiles}
}
